<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Olga & Oriol — Juegos (Realtime + Shimmer)</title>
<style>
  :root{
    --bg:#f6f4f2;
    --card:#ffffff;
    --muted:#6c7a72;
    --primary:#2f6f5e;
    --pill:#e6efe9;
    --success-bg:#e8f7ec;
    --success:#1c7c3a;
    --border:#e7e3dd;
    --shadow: 0 6px 16px rgba(0,0,0,.06);
    --radius:14px;

    --uri:#2e7d32;
    --olga:#2f6f8a;
    --danger:#c0392b;
    --toast:#1f2a27;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#2a2a2a;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:20px 16px 28px}

  /* Header */
  header{display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:4px;margin-bottom:10px}
  .logo{ height: clamp(72px, 12vw, 160px); width:auto; display:block; }
  @media (max-width: 640px){.logo{ height: 72px; max-height: 72px; }}
  .scorebar{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
  .pill{background:var(--pill); color:#fff; padding:10px 16px; border-radius:999px; font-weight:800; letter-spacing:.3px; display:inline-flex; align-items:center; gap:10px; box-shadow:var(--shadow)}
  .pill .name{opacity:1; color:#1a1a1a; font-size:13px; font-weight:700; letter-spacing:.08em}
  .pill.uri{background: color-mix(in srgb, var(--uri) 18%, white)}
  .pill.uri .score{color:var(--uri)}
  .pill.olga{background: color-mix(in srgb, var(--olga) 18%, white)}
  .pill.olga .score{color:var(--olga)}
  .pill .score{font-size:18px}
  .lead{font-size:16px; font-weight:800}
  .btn-reset{border:none;background:#fff;border:1px solid var(--border);padding:8px 14px;border-radius:999px;cursor:pointer}
  .btn-reset:hover{filter:brightness(.98)}

  /* Progress */
  .progress{width:100%;max-width:560px;margin:0 auto 6px}
  .progress .label{display:flex;justify-content:space-between; font-size:12px; color:var(--muted); margin:8px 4px}
  .bar{height:8px;background:#e9ecec;border-radius:999px;overflow:hidden}
  .bar > span{display:block;height:100%;width:0;background: color-mix(in srgb, var(--primary) 45%, white); border-radius:999px; transition:width .35s ease}

  /* Filters */
  .filters{display:flex; gap:8px; justify-content:center; margin:16px 0 12px; flex-wrap:wrap}
  .chip{border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600; color:#385247}
  .chip.active{background: color-mix(in srgb, var(--primary) 10%, white); border-color: color-mix(in srgb, var(--primary) 25%, white)}

  /* Card tiles */
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
  @media(min-width:1060px){.grid{grid-template-columns:1fr 1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;cursor:pointer;transition:transform .06s ease}
  .card:hover{transform:translateY(-2px)}
  .meta-row{display:flex;align-items:center;gap:8px;margin:0 0 6px;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.08em}
  .card .title{display:block; font-weight:800; color:#2e4b3d; text-decoration:none; margin-bottom:6px; font-size:16px}
  .card.completed{background:var(--success-bg); border-color:#cfead7}
  .badge{display:inline-flex;align-items:center;gap:6px;margin-top:10px;color:var(--success);font-weight:700}
  .badge .check{width:18px;height:18px;border-radius:4px;border:2px solid var(--success);display:inline-flex;align-items:center;justify-content:center;font-size:14px}

  /* Skeleton / Shimmer */
  .skeleton{pointer-events:none}
  .skeleton .line{height:12px;border-radius:6px;background:#eee;position:relative;overflow:hidden}
  .skeleton .line.title{height:18px;border-radius:8px;margin-top:6px}
  .skeleton .line.badge{height:16px;border-radius:8px;width:90px}
  .skeleton .line:not(.title){margin:6px 0 0}
  .shimmer::after{
    content:'';position:absolute;inset:0;
    background:linear-gradient(110deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.35) 40%, rgba(255,255,255,0) 80%);
    transform:translateX(-100%);
    animation:shine 1.2s infinite;
  }
  @keyframes shine{to{transform:translateX(100%)}}

  /* Modal */
  .modal-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  display:none;
  align-items:center;
  justify-content:center;
  padding: max(16px, env(safe-area-inset-top)) 16px max(16px, env(safe-area-inset-bottom)) 16px;
  z-index:1000;
}

  .modal{
  background:#fff;
  max-width:720px;
  width:100%;
  border-radius:16px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  max-height: calc(100dvh - (max(16px, env(safe-area-inset-top)) + max(16px, env(safe-area-inset-bottom))));
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

  .modal header{
  display:flex;
  flex-direction:row;
  align-items:flex-start;
  justify-content:space-between;
  margin:0;
  padding:16px 16px 0;
  position:sticky;
  top:0;
  background:#fff;
  z-index:2;
}

  .modal .content{
  padding:0 16px 16px;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  min-height:0;
  flex: 1 1 auto;
}

  .modal h1{font-size:20px;margin:2px 0 6px}
  .modal .meta{color:var(--muted);font-size:13px;margin-bottom:8px}
  .close{background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer}
  .section-block{background:#fff;border:1px dashed var(--border);border-radius:12px;padding:12px;margin:8px 0}
  .section-block h4{margin:0 0 6px;font-size:14px;color:#2e4b3d}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .controls.stack{flex-direction:column; align-items:stretch}
  .controls.center{justify-content:center}
  .choice{border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:#fff; display:flex; align-items:center; gap:8px; cursor:pointer}
  .choice input{accent-color:var(--primary)}
  .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--primary);color:#fff}
  .btn.ghost{background:#fff;border:1px solid var(--border)}
  .btn.danger{background: #fff; color: var(--danger); border:1px solid color-mix(in srgb, var(--danger) 30%, white)}
  .hint{font-size:12px;color:#2f3b36; display:none;}
  .divider{height:1px;background:var(--border);margin:12px 0}
  .counter{display:flex;align-items:center;gap:8px}
  .counter .score{min-width:28px;text-align:center;font-weight:800}
  footer{margin-top:24px;text-align:center;color:#2f3b36}

  /* Toast */
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:var(--toast);color:#fff;padding:8px 14px;border-radius:999px;display:none;z-index:1200;box-shadow:var(--shadow);font-size:12px;white-space:nowrap}

  /* Open Game Button */
  #openGameBtn {
    display:inline-block;
    background:#f0f4ff;
    color:#1a4ab9;
    border:1px solid #d0dcf7;
    border-radius:10px;
    padding:8px 14px;
    font-weight:600;
    text-align:center;
    text-decoration:none;
    margin:6px 0;
    transition:background 0.2s;
  }
  #openGameBtn:hover {
    background:#e2eaff;
  }
  
  details.exp > summary{
    list-style: none; cursor: pointer; display:flex; align-items:center; gap:.5rem;
  }
  details.exp > summary::marker{ content:""; } /* quita el marcador por defecto */
  details.exp > summary::-webkit-details-marker{ display:none; } /* oculta triángulo nativo iPad/iOS */
  details.exp .chev{ transition: transform .2s; }
  details.exp[open] .chev{ transform: rotate(90deg); }
  details.exp .hint{ font-weight:400; font-size:.9em; color:#6b7280; margin-left:.25rem; }


  body.modal-open{ overflow:hidden; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="logo.png" alt="Olga & Oriol — 04.10.2025" class="logo" />
      <div class="progress">
        <div class="label"><span id="progressText">0 de 0 completados</span></div>
        <div class="bar"><span id="progressBar"></span></div>
      </div>
      <div class="scorebar" aria-live="polite">
        <span class="pill uri"><span class="name">Uri</span> <span class="score" id="uriScore">0</span> <span class="lead" id="uriLead"></span></span>
        <span class="pill olga"><span class="name">Olga</span> <span class="score" id="olgaScore">0</span> <span class="lead" id="olgaLead"></span></span>
        <button class="btn-reset" id="resetAll" type="button">Reset</button>
      </div>
    </header>

    <div class="filters">
      <button class="chip active" data-filter="all">Todos</button>
      <button class="chip" data-filter="pending">Pendientes</button>
      <button class="chip" data-filter="done">Completados</button>
    </div>

    <div class="grid" id="tiles"></div>

    <footer>Hecho con ❤️ para Olga &amp; Oriol.</footer>
  </div>

  <!-- Modal detalle -->
  <div class="modal-backdrop" id="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <div>
          <div class="meta" id="detailCategory">Categoría</div>
          <h1 id="detailTitle">Título</h1>
        </div>
        <button class="close" id="closeDetail" type="button">Cerrar</button>
      </header>
      <div class="content">
        <div class="section-block">
          <h4>Preparación</h4>
          <div id="detailPrep"></div>
        </div>
        <div class="section-block">
          <h4>Instrucciones</h4>
          <div id="detailInstr"></div>
        </div>
        <div class="divider"></div>
        <div class="section-block" id="scoringBlock">
          <h4>Puntuación</h4>
          <div id="scoringControls" class="responsive"></div>
          <div class="hint" id="scoringHint"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

<!-- Firebase SDK (v10 compat builds for simplicity) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

<script>
// === CONFIGURA TU PROYECTO ===
const firebaseConfig = {
  apiKey: "AIzaSyDyVVC7MsVQ11S9-8fmUVTmyv9cMKVL1zE",
  authDomain: "despedida-uriga.firebaseapp.com",
  projectId: "despedida-uriga",
  storageBucket: "despedida-uriga.firebasestorage.app",
  messagingSenderId: "733159815599",
  appId: "1:733159815599:web:99ba9edcd19721cca0d75a",
  measurementId: "G-BHXFTMXEDV",
  databaseURL: "https://despedida-uriga-default-rtdb.europe-west1.firebasedatabase.app"
};

// === App + Auth anónima (requerida por las reglas) ===
firebase.initializeApp(firebaseConfig);

// Mostrar skeleton inmediatamente
const tiles = document.getElementById('tiles');
showSkeleton(9);

// Firmar anónimo y, cuando esté, enganchar listeners
firebase.auth().signInAnonymously().catch(console.error);
firebase.auth().onAuthStateChanged((user)=>{
  if(user){ boot(); }
});

// === RTDB refs ===
let db, scoresRef, gamesRef;

// === Catálogo local de juegos ===
const GAMES_CATALOG = [
  { id:'madrecdotas', category:'Emancipación', title:'Las Madrecdotas', emoji:'👨🏻‍⚖️',
    type:'points',
    prep: `App web con todas las anécdotas.`,
    instructions: `
      <ol>
        <li><strong>El abogado lee</strong> una anécdota.</li>
        <li>Uri y Olga dicen de quién creen que es (<strong>sin hablar entre ellos</strong>).</li>
        <li>Repetir hasta acabar todas las anecdotas.</li>
        <li>El autor puede añadir detalles.</li>
      </ol>
    `
  },
  { id:'cordon', category:'Emancipación', title:'Cortar ataduras (doble Human Knot)', emoji:'🧶',
    type:'versus',
    prep: `
      <ul>
        <li>2 equipos del mismo tamaño (mín. 6 por equipo).</li>
        <li>Puede haber gente que no juegue.</li>
      </ul>
    `,
    instructions: `
      <ol>
        <li>Cada persona da <strong>mano derecha</strong> a alguien <strong>enfrente</strong> y la <strong>izquierda</strong> a <strong>otra distinta</strong> enfrente (<em>nunca a adyacentes</em>).</li>
        <li><strong>Uri y Olga</strong> no se atan: actúan como <strong>guías</strong>.</li>
        <li><strong>Sin soltarse</strong>, seguir sus indicaciones para deshacer el nudo.</li>
        <li>Se completa cuando todos dan la mano al de al lado formando <strong>un círculo</strong>.</li>
        <li><strong>Gana</strong> el primer equipo que lo logra; si solo uno lo logra, gana. <strong>Empate</strong> si acaban con ≤30 s de diferencia.</li>
      </ol>
    `
  },
  { id:'microbiotas', category:'Introducción de Olga al clan', title:'Banco de Microbiotas', emoji:'🦠',
    type:'points',
    prep: `
      <ul>
        <li>1 tupper por persona (lo presenta quien lo trae).</li>
        <li>Antifaces (para Uri y Olga), toallitas, libreta y bolis.</li>
      </ul>
    `,
    instructions: `
      <ol>
        <li>Con antifaz, cada uno <strong>toca 30 s</strong> el tupper presentado.</li>
        <li>Escribir en secreto la apuesta.</li>
        <li><strong>+1</strong> por acierto o mayor aproximación (ambos pueden sumar).</li>
        <li>Repetir con todos. Gana quien sume más.</li>
      </ol>
    `
  },
  { id:'tiktok', category:'Introducción de Olga al clan', title:'Intenta No Reír — Retos de Baile', emoji:'💃',
    type:'points',
    prep: `
      <ul>
        <li>Móvil con <strong>app web</strong> (coreografías) + altavoz.</li>
        <li>Botella grande de agua y toalla.</li>
      </ul>
    `,
    instructions: `
      <ol>
        <li>Un jugador del Equipo A se sienta con <strong>agua en la boca</strong> (defiende).</li>
        <li>El Equipo B baila, <strong>sin saltárselos</strong>, los <strong>3 bailes consecutivos</strong> que da la app (no se eligen).</li>
        <li>Si el defensor ríe/escupe → <strong>+1</strong> para quien baila y fin del turno.</li>
        <li>Si no ríe tras 3 bailes → <strong>0 puntos</strong> y cambio de turno.</li>
        <li>Alternar equipos y rotar defensores. <strong>Gana</strong> quien sume más puntos (puede haber empate).</li>
      </ol>
    `
  },
  { id:'cata', category:'Introducción de Olga al clan', title:'Cata de bebidas (a ciegas)', emoji:'🍷',
    type:'versus',
    prep: `
      <ul>
        <li>Caja opaca con <strong>5 orificios</strong>.</li>
        <li><strong>5 botellas de agua</strong> (+ una grande para rellenar), salsa picante.</li>
        <li>Pajitas <strong>nuevas</strong> en cada sorbo. El equipo rival <strong>reemplaza progresivamente las aguas</strong>.</li>
      </ul>
    `,
    instructions: `
      <ol>
        <li>Juega un equipo completo por turnos (el otro prepara).</li>
        <li>Inicio: <strong>4 aguas</strong> y <strong>1 picante</strong>.</li>
        <li>Cada jugador elige un orificio y bebe:
          <ul>
            <li>Si es <strong>picante</strong> → jugador <strong>eliminado</strong> (las picantes <em>no se mueven</em>).</li>
            <li>Si es <strong>agua</strong> → el rival <strong>añade una nueva picante sustituyendo una de agua</strong>.</li>
          </ul>
        </li>
        <li>Continuar hasta <strong>eliminar todas las aguas</strong> (queden 5 picantes). <strong>Se cronometra</strong>. Repite con el otro equipo.</li>
        <li><strong>Victoria:</strong> si ambos completan, gana el más rápido; si ninguno, gana quien elimine más aguas. Empate si igualan.</li>
      </ol>
    `
  },
  { id:'siameses', category:'Fusión en Uriga', title:'Mini‑retos a dos manos', emoji:'🤝',
    type:'ritual',
    prep: `
      <ul>
        <li><strong>Cuerda</strong> para atar sus manos juntas.</li>
        <li>Hojas DIN A4 (varias), tijeras, papel de regalo, celo, objeto para envolver (p. ej., un libro).</li>
        <li>10 globos, rotulador, cronómetro.</li>
      </ul>
    `,
    instructions: `
      <ol>
        <li>Muñecas atadas entre sí (derecha de uno con izquierda del otro). Cada uno usa su <strong>mano libre</strong>.</li>
        <li>Completar 3 miniretos, <strong>2 min</strong> cada uno:
          <ol type="a">
            <li>Avión de papel (A4) que vuele ≥5 m.</li>
            <li>Envolver el objeto como regalo.</li>
            <li>Hinchado y nudo de un globo + dibujarle una cara.</li>
          </ol>
        </li>
      </ol>
      <p><em>Ritual, sin puntos.</em></p>
    `
  },
  { id:'musical', category:'Fusión en Uriga', title:'Recuerdos de Uriga: El Musical', emoji:'🎭',
    type:'ritual',
    prep: `App web con la lista de escenas y altavoces para música de fondo.`,
    instructions: `
      <ol>
        <li>La app muestra una <strong>escena</strong> y un <strong>equipo</strong> (Uri u Olga).</li>
        <li>Ese equipo la improvisa <strong>cantando y/o bailando</strong> durante <strong>2–3 min</strong>.</li>
        <li>Pasa el otro equipo con la siguiente escena, y así hasta completar todas.</li>
      </ol>
      <p><em>Ritual, sin puntos.</em></p>
    `
  },
  { id:'yincana', category:'UriGPT', title:'Yincana de fotos — Edición Multiagente', emoji:'📸',
    type:'versus',
    prep: `Lista de retos/fotos, 1 móvil por equipo, <strong>tiempo máx.: 12 min</strong>.`,
    instructions: `
      <p>Cada foto representa un <strong>rol de Uri</strong> con <strong>condición obligatoria</strong>. +1 por foto válida dentro del tiempo. Juegan ambos equipos a la vez. <strong>Gana</strong> quien logre más fotos válidas (puede haber empate).</p>
      <details class="exp">
        <summary>
          <span class="chev" aria-hidden="true">▸</span>
          <strong>Retos y condiciones</strong>
          <span class="hint">toca para ver</span>
        </summary>
        <ul>
          <li><strong>Uri Espiritista</strong> 🧹👻 — <em>≥1 persona no toca el suelo.</em></li>
          <li><strong>Uri Cocinero</strong> 🧀 — <em>Todo el equipo forma/está dentro de un “horno”.</em></li>
          <li><strong>Uri Jardinero</strong> 🌱 — <em>1 jugador hace de potus; el resto lo trata con amor/reverencia (como hippies).</em></li>
          <li><strong>Uri Domótica</strong> 🕹️ — <em>Alguien hace de Uri actuando como objeto de domótica silencioso, pero visible en la foto.</em></li>
          <li><strong>Uri Tarotista</strong> 🔮 — <em>El grupo representa distintas cartas del tarot que le tiran al consultante.</em></li>
          <li><strong>Uri Motorista</strong> 🏍️ — <em>Moto hecha con cuerpos humanos conectados; ≥1 pasajero subido.</em></li>
          <li><strong>Uri Masajista</strong> 💆 — <em>Camilla/silla humana + un masajista y un paciente.</em></li>
          <li><strong>Uri Exterminador de Plagas</strong> 🪳 — <em>Varias cucarachas representadas y escena dramática.</em></li>
        </ul>
      </details>
    `
  },
  { id:'recogida', category:'Vida en el Palacete', title:'Mudanza a ciegas', emoji:'🙈',
    type:'versus',
    prep: `Campo delimitado; 2 bases (una por equipo); piezas del color de cada equipo (tantas como jugadores, nº <strong>par</strong>); 2 antifaces; <strong>sin obstáculos</strong>.`,
    instructions: `
      <ol>
        <li>Rondas <strong>simultáneas</strong>: cada equipo elige 1 jugador que irá a ciegas.</li>
        <li>Poner el antifaz y darle <strong>2–3 vueltas</strong> para desorientarlo suavemente.</li>
        <li><strong>Todo el equipo</strong> grita instrucciones (no solo una persona).</li>
        <li>El ciego coge <strong>1 pieza de su color</strong> y vuelve a su base. Rotar jugador.</li>
        <li><strong>Gana</strong> el equipo que reúne todas sus piezas primero. <strong>Empate</strong> si terminan con ≤5 s de diferencia.</li>
      </ol>
    `
  },
  { id:'nofoto', category:'Vida en el Palacete', title:'No salgas en la foto — Versión cucarachas', emoji:'🪳',
    type:'versus',
    prep: `Espacio delimitado (pequeño); 1 móvil con cámara por equipo; 1 antifaz.`,
    instructions: `
      <ol>
        <li><strong>Turno A:</strong> un jugador del Equipo A se pone el antifaz y toma la cámara; el Equipo B hace de <strong>cucarachas</strong> (ruidos y movimiento).</li>
        <li>Tiene <strong>1:30 min</strong> para sacar <strong>hasta 10 fotos</strong> (si hace más, solo cuentan las 10 primeras).</li>
        <li><strong>Puntuación:</strong> contar las <strong>personas</strong> que aparezcan en esas fotos válidas.</li>
        <li><strong>Turno B:</strong> invertir roles. Jugar <strong>2–3 rondas</strong>, cambiando de fotógrafo cada vez.</li>
        <li><strong>Gana</strong> quien acumule más “cucarachas” fotografiadas (empate si igualan).</li>
      </ol>
    `
  },
  { id:'riego', category:'Vida en el Palacete', title:'Riego Milagroso — Pasa el agua atrás', emoji:'💧',
    type:'versus',
    prep: `Dos filas (mismo nº de personas), <strong>1–2 botellas por equipo</strong>, <strong>vasos del mismo tamaño</strong> para cada jugador (≈14) y <strong>recipiente final grande</strong>.`,
    instructions: `
      <ol>
        <li>A la señal, el primero pasa <strong>agua por encima de la cabeza</strong> al de detrás, sin girarse ni mirar atrás.</li>
        <li>Cada jugador <strong>rellena el vaso</strong> del compañero inmediatamente detrás, en cadena.</li>
        <li>El último vierte su vaso en el <strong>recipiente final</strong> (este sí puede mirar).</li>
        <li><strong>Tiempo máx.: 5 min</strong> o hasta llenar el recipiente.</li>
        <li><strong>Gana</strong> el equipo que lo llene antes; si nadie lo llena, gana quien tenga más agua al final (empate si igualan).</li>
      </ol>
    `
  },
  { id:'sprite', category:'Bonus Final', title:'Exorcismo de Maitreya', emoji:'🫧',
    type:'points',
    prep: `2–3 botellas de Sprite muy frías, <strong>vasos iguales</strong> (uno por duelista), toallas y cronómetro.`,
    instructions: `
      <ol>
        <li><strong>Duelos 1 vs 1</strong>: ambos beben su vaso y aguantan <strong>45–60 s</strong>.</li>
        <li>Si uno <strong>eructa</strong>, el otro gana <strong>+1</strong> y fin del duelo (si eructan a la vez, 0).</li>
        <li>Rotar parejas y repetir rondas.</li>
        <li><strong>Final:</strong> quien tenga más puntos locales obtiene <strong>+1 global</strong>; si empatan, <strong>+1 global</strong> ambos.</li>
      </ol>
    `
  }
];

// === DOM helpers ===
const $ = (q)=>document.querySelector(q);
const uriScoreEl = $('#uriScore');
const olgaScoreEl = $('#olgaScore');
const progressText = $('#progressText');
const progressBar = $('#progressBar');
let FILTER = 'all';

// Skeleton generator
function showSkeleton(n=9){
  tiles.innerHTML='';
  for(let i=0;i<n;i++){
    const el=document.createElement('article');
    el.className='card skeleton';
    el.innerHTML=`
      <div class="meta-row">
        <div class="line shimmer" style="width:140px"></div>
      </div>
      <div class="line title shimmer" style="width:80%"></div>
      <div class="line shimmer" style="width:60%"></div>
      <div class="line badge shimmer" style="margin-top:12px"></div>
    `;
    tiles.appendChild(el);
  }
}

// Toast helper
function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>{ t.style.display='none'; }, 1800);
}

// === Boot once authenticated ===
async function boot(){
  db = firebase.database();
  scoresRef = db.ref('scores');
  gamesRef  = db.ref('games');

  // Listeners en tiempo real
  scoresRef.on('value', snap=>{
    const s = snap.val() || {uri:0, olga:0};
    uriScoreEl.textContent = s.uri||0;
    olgaScoreEl.textContent = s.olga||0;
    const uriLead = $('#uriLead'); const olgaLead = $('#olgaLead');
    const u = s.uri||0, o = s.olga||0;
    uriLead.textContent = u>o?'↑':(u<o?'↓':' ');
    olgaLead.textContent = o>u?'↑':(o<u?'↓':' ');
  });

  let firstGames = true;
  gamesRef.on('value', snap=>{
    const all = snap.val();
    if(!all){
      // Primera vez sin datos: inicializamos y seguimos en skeleton hasta que suba
      seedGames().then(()=>{});
      return;
    }
    renderTiles(all);
    if(firstGames){
      firstGames = false;
    }
  });

  // Init si no existen
  const s = await scoresRef.get();
  if(!s.exists()) await scoresRef.set({uri:0, olga:0});
  const g = await gamesRef.get();
  if(!g.exists()) await seedGames();
}

async function seedGames(){
  const seed = {};
  GAMES_CATALOG.forEach((gc, idx)=>{
    seed[gc.id] = { done:false, result:null, local:{u:0,o:0}, type:gc.type, order:idx+1 };
  });
  await gamesRef.set(seed);
}

// === PROGRESO ===
function renderProgressFrom(allGames){
  const arr = Object.values(allGames);
  const total = arr.length;
  const done = arr.filter(g=>!!g.done).length;
  progressText.textContent = `${done} de ${total} completados`;
  progressBar.style.width = `${total? (done/total)*100 : 0}%`;
}

// === TILES ===
function renderTiles(allGames){
  tiles.innerHTML = '';
  // mantener orden estable por 'order' o catálogo
  const byOrder = [...GAMES_CATALOG].sort((a,b)=>{
    const A = allGames[a.id]?.order ?? 0;
    const B = allGames[b.id]?.order ?? 0;
    return A - B;
  });

  byOrder.forEach((gc, idx)=>{
    const state = allGames[gc.id] || {done:false};
    const completed = !!state.done;
    if(FILTER==='pending' && completed) return;
    if(FILTER==='done' && !completed) return;
    const el = document.createElement('article');
    el.className = 'card' + (completed ? ' completed' : '');
    el.setAttribute('data-id', gc.id);
    el.innerHTML = `
      <div class="meta-row"><span>${gc.category}</span></div>
      <span class="title">${gc.emoji} ${String(idx+1).padStart(2,'0')}. ${gc.title}</span>
      ${completed ? `<div class="badge"><span class="check">✓</span>Completado</div>`:''}
    `;
    el.addEventListener('click', ()=>openDetail(gc.id, allGames));
    tiles.appendChild(el);
  });
  renderProgressFrom(allGames);
}

// === Filtros ===
document.querySelectorAll('.chip').forEach(ch=>{
  ch.addEventListener('click', async ()=>{
    document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    ch.classList.add('active');
    FILTER = ch.dataset.filter;
    showSkeleton(6);
    const s = await gamesRef.get();
    renderTiles(s.val()||{});
  });
});

// === RESET GLOBAL (sin confirm) ===
document.getElementById('resetAll').addEventListener('click', async ()=>{
    if(!confirm('¿Quieres reiniciar todo? Esto borrará los puntos globales y locales y pondrá todos los juegos como no empezados.')) return;
try{
    // 1) Reset marcador global a 0
    await scoresRef.set({uri:0, olga:0});

    // 2) Reset de TODOS los juegos como hacen los modals:
    //    done:false, result:null, local:{u:0,o:0} (manteniendo type y order)
    const snapshot = await gamesRef.get();
    const current = snapshot.val() || {};
    const updates = {};
    GAMES_CATALOG.forEach((gc, idx)=>{
      const prev = current[gc.id] || {};
      updates[gc.id] = {
        type: prev.type ?? gc.type,
        order: prev.order ?? (idx+1),
        done: false,
        result: null,
        local: {u:0, o:0}
      };
    });
    await gamesRef.update(updates);

    showToast('Todo reiniciado');
  }catch(err){
    console.error('Reset error:', err);
    showToast('Error al reiniciar');
  }
});

// === MODAL ===
const backdrop = $('#backdrop');
const closeBtn = $('#closeDetail');
closeBtn.addEventListener('click', closeDetail);
backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeDetail(); });

function openDetail(id, allGames){
  const gc = GAMES_CATALOG.find(x=>x.id===id);
  if(!gc) return;
  $('#detailCategory').textContent = gc.category;
  $('#detailTitle').textContent = gc.title;
  $('#detailPrep').innerHTML = gc.prep;
  $('#detailInstr').innerHTML = gc.instructions;

  
  const _contentEl = document.querySelector('.modal .content'); if(_contentEl){ _contentEl.scrollTop = 0; }
// --- Enlace externo para juegos específicos ---
  (function(){
    const LINKS = {
      madrecdotas: 'https://kevinpujol.github.io/Despedida-Uriga-Madrecdotas/',
      tiktok: 'https://kevinpujol.github.io/Despedida-Uriga-Retos-Baile/',
      musical: 'https://kevinpujol.github.io/Despedida-Uriga-Escenas-Musicales/'
    };
    const contentEl = document.querySelector('.modal .content');
    const prevBtn = document.getElementById('openGameBtn');
    if(prevBtn && prevBtn.parentElement){ prevBtn.parentElement.remove(); }
    const href = LINKS[id];
    if(href && contentEl){
      const firstSection = contentEl.querySelector('.section-block');
      const wrap = document.createElement('div');
      wrap.className = 'controls';
      wrap.style.margin = '0 0 8px';
      const a = document.createElement('a');
      a.id = 'openGameBtn';
      a.className = 'btn ghost';
      a.href = href;
      a.target = '_blank';
      a.rel = 'noopener';
      a.textContent = 'Abrir juego';
      wrap.appendChild(a);
      contentEl.insertBefore(wrap, firstSection);
    }
  })();

const state = (allGames && allGames[id]) || {done:false, result:null, local:{u:0,o:0}};
  const sc = $('#scoringControls');
  const hint = $('#scoringHint');
  sc.innerHTML = '';
  hint.style.display = 'none';

  // Helpers DB
  function txAddScore(who, delta){
    return scoresRef.child(who).transaction(cur => (cur||0) + delta);
  }
  function setGameState(id, data){
    return gamesRef.child(id).update(data);
  }

  const isLocked = !!state.done && !!state.result && state.result !== 'DONE';

  if(gc.type==='points'){
    const wrap = document.createElement('div');
    wrap.className = 'controls responsive center';
    wrap.innerHTML = `
      <div class="counter"><strong>Uri</strong>
        <button class="btn ghost" id="uMinus">−1</button>
        <span class="score" id="uScore">${state.local?.u||0}</span>
        <button class="btn primary" id="uPlus">+1</button>
      </div>
      <div class="counter"><strong>Olga</strong>
        <button class="btn ghost" id="oMinus">−1</button>
        <span class="score" id="oScore">${state.local?.o||0}</span>
        <button class="btn primary" id="oPlus">+1</button>
      </div>
      <div class="controls stack" style="width:100%;max-width:420px">
        <button class="btn ghost" id="resetLocal">Reset puntos</button>
        <button class="btn primary" id="finalize">Finalizar juego</button>
        <button class="btn danger" id="clearResult">Quitar resultado</button>
      </div>
    `;
    sc.appendChild(wrap);

    function setLocal(newU, newO){
      document.getElementById('uScore').textContent = newU;
      document.getElementById('oScore').textContent = newO;
      setGameState(id, { local:{u:newU, o:newO} });
    }

    // Bind handlers
    sc.querySelector('#uPlus').onclick = ()=> { const curU=+(document.getElementById('uScore').textContent||0); const curO=+(document.getElementById('oScore').textContent||0); setLocal(curU+1, curO); };
    sc.querySelector('#uMinus').onclick = ()=> { const curU=+(document.getElementById('uScore').textContent||0); const curO=+(document.getElementById('oScore').textContent||0); setLocal(Math.max(0,curU-1), curO); };
    sc.querySelector('#oPlus').onclick = ()=> { const curU=+(document.getElementById('uScore').textContent||0); const curO=+(document.getElementById('oScore').textContent||0); setLocal(curU, curO+1); };
    sc.querySelector('#oMinus').onclick = ()=> { const curU=+(document.getElementById('uScore').textContent||0); const curO=+(document.getElementById('oScore').textContent||0); setLocal(curU, Math.max(0,curO-1)); };
    sc.querySelector('#resetLocal').onclick = ()=> setLocal(0,0);

    sc.querySelector('#finalize').onclick = async ()=>{
      const curU = +(document.getElementById('uScore').textContent||0);
      const curO = +(document.getElementById('oScore').textContent||0);
      let outcome = 'DRAW';
      if(curU > curO) outcome = 'URI';
      else if(curO > curU) outcome = 'OLGA';

      const prevSnap = await gamesRef.child(id).child('result').get();
      const prev = prevSnap.val();
      if(!prev){
        if(outcome==='URI') await txAddScore('uri', +1);
        else if(outcome==='OLGA') await txAddScore('olga', +1);
        else { await txAddScore('uri', +1); await txAddScore('olga', +1); }
      }
      await setGameState(id, { result:outcome, done:true });
      showToast(`Resultado: ${outcome==='DRAW'?'Empate (+1 a ambos)':(outcome==='URI'?'Uri':'Olga')+' (+1 global)'}`);
      closeDetail();
    };

    sc.querySelector('#clearResult').onclick = async ()=>{
      const prev = (await gamesRef.child(id).child('result').get()).val();
      if(!prev){ alert('Este juego no tenía resultado.'); return; }
      if(!confirm('¿Estás seguro de quitar el resultado y reabrir este juego?')) return;
      if(prev==='URI') await txAddScore('uri', -1);
      else if(prev==='OLGA') await txAddScore('olga', -1);
      else if(prev==='DRAW'){ await txAddScore('uri', -1); await txAddScore('olga', -1); }
      await setGameState(id, { result:null, done:false, local:{u:0,o:0} });
      showToast('Resultado eliminado');
      closeDetail();
    };

    // UI LOCK after finalize
    if(isLocked){
      ['uMinus','uPlus','oMinus','oPlus','resetLocal','finalize'].forEach(idBtn=>{
        const b = sc.querySelector('#'+idBtn);
        if(b) b.disabled = true;
      });
      const h = document.getElementById('scoringHint');
      h.textContent = 'Juego cerrado. Usa “Quitar resultado” para reabrir.';
      h.style.display = 'block';
    }

  } else if(gc.type==='versus'){
    const wrap = document.createElement('div');
    wrap.className = 'controls responsive center';
    wrap.innerHTML = `
      <label class="choice"><input type="radio" name="winner" value="URI" ${state.result==='URI'?'checked':''}> Uri gana</label>
      <label class="choice"><input type="radio" name="winner" value="OLGA" ${state.result==='OLGA'?'checked':''}> Olga gana</label>
      <label class="choice"><input type="radio" name="winner" value="DRAW" ${state.result==='DRAW'?'checked':''}> Empate</label>
      <div class="controls stack" style="width:100%;max-width:420px">
        <button class="btn primary" id="saveResult">Guardar</button>
        <button class="btn danger" id="clearResult">Quitar resultado</button>
      </div>
    `;
    sc.appendChild(wrap);

    sc.querySelector('#saveResult').onclick = async ()=>{
      const sel = sc.querySelector('input[name="winner"]:checked');
      if(!sel){ alert('Selecciona un resultado.'); return; }
      const val = sel.value;
      const prev = (await gamesRef.child(id).child('result').get()).val();
      if(!prev){
        if(val==='URI') await scoresRef.child('uri').transaction(cur => (cur||0)+1);
        else if(val==='OLGA') await scoresRef.child('olga').transaction(cur => (cur||0)+1);
        else { await scoresRef.child('uri').transaction(cur => (cur||0)+1); await scoresRef.child('olga').transaction(cur => (cur||0)+1); }
      }
      await gamesRef.child(id).update({ result:val, done:true });
      showToast('Resultado guardado');
      closeDetail();
    };

    sc.querySelector('#clearResult').onclick = async ()=>{
      const prev = (await gamesRef.child(id).child('result').get()).val();
      if(!prev){ alert('Este juego no tenía resultado.'); return; }
      if(!confirm('¿Estás seguro de quitar el resultado y reabrir este juego?')) return;
      if(prev==='URI') await scoresRef.child('uri').transaction(cur => Math.max(0,(cur||0)-1));
      else if(prev==='OLGA') await scoresRef.child('olga').transaction(cur => Math.max(0,(cur||0)-1));
      else { await scoresRef.child('uri').transaction(cur => Math.max(0,(cur||0)-1)); await scoresRef.child('olga').transaction(cur => Math.max(0,(cur||0)-1)); }
      await gamesRef.child(id).update({ result:null, done:false });
      showToast('Resultado eliminado');
      closeDetail();
    };

    // UI LOCK after finalize
    if(isLocked){
      // Disable radios and save button, keep Clear Result active
      sc.querySelectorAll('input[name="winner"]').forEach(inp=>{ inp.disabled = true; });
      const saveBtn = sc.querySelector('#saveResult');
      if(saveBtn) saveBtn.disabled = true;
      const h = document.getElementById('scoringHint');
      h.textContent = 'Juego cerrado. Usa “Quitar resultado” para reabrir.';
      h.style.display = 'block';
    }

  } else if(gc.type==='ritual'){
    const wrap = document.createElement('div');
    wrap.className = 'controls stack center';
    wrap.innerHTML = `
      <button class="btn primary" id="markDone">${state.done?'Marcar como NO completado':'Marcar como completado'}</button>
    `;
    sc.appendChild(wrap);
    sc.querySelector('#markDone').onclick = async ()=>{
      if(state.done){
        await gamesRef.child(id).update({ done:false, result:null });
        showToast('Marcado como pendiente');
      }else{
        await gamesRef.child(id).update({ done:true, result:'DONE' });
        showToast('Marcado como completado');
      }
      closeDetail();
    };
  }

  backdrop.style.display = 'flex';
  backdrop.setAttribute('aria-hidden','false');
  document.body.classList.add('modal-open');
}

function closeDetail(){
  backdrop.style.display = 'none';
  backdrop.setAttribute('aria-hidden','true');
  document.body.classList.remove('modal-open');
}
</script>
</body>
</html>
