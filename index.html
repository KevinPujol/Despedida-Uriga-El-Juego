<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Olga & Oriol ‚Äî Juegos</title>
<style>
  :root{
    --bg:#f6f4f2;
    --card:#ffffff;
    --muted:#6c7a72;
    --primary:#2f6f5e;
    --pill:#e6efe9;
    --success-bg:#e8f7ec;
    --success:#1c7c3a;
    --border:#e7e3dd;
    --shadow: 0 6px 16px rgba(0,0,0,.06);
    --radius:14px;

    --uri:#2e7d32;
    --olga:#2f6f8a;
    --danger:#c0392b;
    --toast:#1f2a27;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:#2a2a2a;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:20px 16px 28px}

  /* Header */
  header{display:flex;flex-direction:column;align-items:center;gap:12px;margin-top:4px;margin-bottom:10px}
  .logo{height:72px; width:auto; display:block}
  .scorebar{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
  .pill{background:var(--pill); color:#fff; padding:10px 16px; border-radius:999px; font-weight:800; letter-spacing:.3px; display:inline-flex; align-items:center; gap:10px; box-shadow:var(--shadow)}
  .pill .name{opacity:1; color:#1a1a1a; font-size:13px; font-weight:700; letter-spacing:.08em}
  .pill.uri{background: color-mix(in srgb, var(--uri) 18%, white)}
  .pill.uri .score{color:var(--uri)}
  .pill.olga{background: color-mix(in srgb, var(--olga) 18%, white)}
  .pill.olga .score{color:var(--olga)}
  .pill .score{font-size:18px}
  .lead{font-size:16px; font-weight:800}
  .btn-reset{border:none;background:#fff;border:1px solid var(--border);padding:8px 14px;border-radius:999px;cursor:pointer}
  .btn-reset[disabled]{opacity:.6;cursor:not-allowed}
  .btn-reset:hover{filter:brightness(.98)}

  /* Progress */
  .progress{width:100%;max-width:560px;margin:0 auto 6px}
  .progress .label{display:flex;justify-content:space-between; font-size:12px; color:var(--muted); margin:8px 4px}
  .bar{height:8px;background:#e9ecec;border-radius:999px;overflow:hidden}
  .bar > span{display:block;height:100%;width:0;background: color-mix(in srgb, var(--primary) 45%, white); border-radius:999px; transition:width .35s ease}

  /* Filters */
  .filters{display:flex; gap:8px; justify-content:center; margin:10px 0 18px; flex-wrap:wrap}
  .chip{border:1px solid var(--border); background:#fff; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600; color:#385247}
  .chip.active{background: color-mix(in srgb, var(--primary) 10%, white); border-color: color-mix(in srgb, var(--primary) 25%, white)}

  /* Card tiles */
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:720px){.grid{grid-template-columns:1fr 1fr}}
  @media(min-width:1060px){.grid{grid-template-columns:1fr 1fr 1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;cursor:pointer;transition:transform .06s ease}
  .card:hover{transform:translateY(-2px)}
  .meta-row{display:flex;align-items:center;gap:8px;margin:0 0 6px;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.08em}
  .card .title{display:block; font-weight:800; color:#2e4b3d; text-decoration:none; margin-bottom:6px; font-size:16px}
  .card.completed{background:var(--success-bg); border-color:#cfead7}
  .badge{display:inline-flex;align-items:center;gap:6px;margin-top:10px;color:#2f7d55;font-weight:700}
  .badge .check{width:18px;height:18px;border-radius:4px;border:2px solid #2f7d55;display:inline-flex;align-items:center;justify-content:center;font-size:14px}

  /* Skeleton (shimmer) */
  .skeleton{position:relative;overflow:hidden}
  .skeleton::before{
    content:"";position:absolute;inset:0;
    background:linear-gradient(90deg, rgba(0,0,0,0.04), rgba(0,0,0,0.08), rgba(0,0,0,0.04));
    transform:translateX(-100%);animation:sh 1.2s infinite;
  }
  @keyframes sh{to{transform:translateX(100%)}}
  .sk-line{height:14px;background:#eee;border-radius:8px;margin:8px 0}
  .sk-meta{width:50%}
  .sk-title{width:80%;height:18px}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000}
  .modal{background:#fff;max-width:720px;width:100%;border-radius:16px;border:1px solid var(--border);box-shadow:var(--shadow)}
  .modal header{flex-direction:row;align-items:flex-start;justify-content:space-between;margin:0;padding:16px 16px 0}
  .modal .content{padding:0 16px 16px}
  .modal h1{font-size:20px;margin:2px 0 6px}
  .modal .meta{color:var(--muted);font-size:13px;margin-bottom:8px}
  .close{background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px 12px;cursor:pointer}
  .section-block{background:#fff;border:1px dashed var(--border);border-radius:12px;padding:12px;margin:8px 0}
  .section-block h4{margin:0 0 6px;font-size:14px;color:#2e4b3d}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .controls.stack{flex-direction:column; align-items:stretch}
  .controls.center{justify-content:center}
  .choice{border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:#fff; display:flex; align-items:center; gap:8px; cursor:pointer}
  .choice input{accent-color:var(--primary)}
  .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--primary);color:#fff}
  .btn.ghost{background:#fff;border:1px solid var(--border)}
  .btn.danger{background: #fff; color: var(--danger); border:1px solid color-mix(in srgb, var(--danger) 30%, white)}
  .hint{font-size:12px;color:#2f3b3b; display:none;}
  .divider{height:1px;background:var(--border);margin:12px 0}
  .counter{display:flex;align-items:center;gap:8px}
  .counter .score{min-width:28px;text-align:center;font-weight:800}
  footer{margin-top:24px;text-align:center;color:#2f3b36}

  /* Toast */
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:var(--toast);color:#fff;padding:10px 14px;border-radius:999px;display:none;z-index:1200;box-shadow:var(--shadow);font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="logo.png" alt="Olga & Oriol ‚Äî 04.10.2025" class="logo" />
      <div class="progress">
        <div class="label"><span id="progressText">0 de 0 completados</span></div>
        <div class="bar"><span id="progressBar"></span></div>
      </div>
      <div class="scorebar" aria-live="polite">
        <span class="pill uri"><span class="name">Uri</span> <span class="score" id="uriScore">0</span> <span class="lead" id="uriLead"></span></span>
        <span class="pill olga"><span class="name">Olga</span> <span class="score" id="olgaScore">0</span> <span class="lead" id="olgaLead"></span></span>
        <button class="btn-reset" id="resetAll" type="button">Reset</button>
      </div>
    </header>

    <div class="filters">
      <button class="chip active" data-filter="all">Todos</button>
      <button class="chip" data-filter="pending">Pendientes</button>
      <button class="chip" data-filter="done">Completados</button>
    </div>

    <div class="grid" id="tiles">
      <!-- skeletons -->
    </div>

    <footer>Hecho con ‚ù§Ô∏è para Olga &amp; Oriol.</footer>
  </div>

  <!-- Modal detalle -->
  <div class="modal-backdrop" id="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <div>
          <div class="meta" id="detailCategory">Categor√≠a</div>
          <h1 id="detailTitle">T√≠tulo</h1>
        </div>
        <button class="close" id="closeDetail" type="button">Cerrar</button>
      </header>
      <div class="content">
        <div class="section-block">
          <h4>Preparaci√≥n</h4>
          <div id="detailPrep"></div>
        </div>
        <div class="section-block">
          <h4>Instrucciones</h4>
          <div id="detailInstr"></div>
        </div>
        <div class="divider"></div>
        <div class="section-block" id="scoringBlock">
          <h4>Puntuaci√≥n</h4>
          <div id="scoringControls" class="responsive"></div>
          <div class="hint" id="scoringHint"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getDatabase, ref, onValue, get, set, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

// --- Config ---
const firebaseConfig = {
  apiKey: "AIzaSyDyVVC7MsVQ11S9-8fmUVTmyv9cMKVL1zE",
  authDomain: "despedida-uriga.firebaseapp.com",
  databaseURL: "https://despedida-uriga-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "despedida-uriga",
  storageBucket: "despedida-uriga.firebasestorage.app",
  messagingSenderId: "733159815599",
  appId: "1:733159815599:web:99ba9edcd19721cca0d75a",
  measurementId: "G-BHXFTMXEDV"
};

// --- Juegos (seed de UI, descripciones locales) ---
const GAMES_META = [
  { id:'madrecdotas', category:'Emancipaci√≥n', title:'Las Madrecdotas', emoji:'‚öñÔ∏è', type:'points',
    prep:'Caja con an√©cdotas impresas y autor indicado.',
    instructions:'El MC lee una an√©cdota. Uri y Olga dicen de qui√©n es (sin hablar entre ellos). Asigna +1 local al que acierte.'
  },
  { id:'cordon', category:'Emancipaci√≥n', title:'Cortar el cord√≥n (doble Human Knot)', emoji:'ü™¢', type:'versus',
    prep:'Formar 2 grupos del mismo tama√±o. Manos a personas no adyacentes.',
    instructions:'Sin soltarse, seguir a su gu√≠a para deshacer el nudo. Resultado: Uri / Olga / Empate (suma al marcador global).'
  },
  { id:'microbiotas', category:'Introducci√≥n de Olga al clan', title:'Banco de Microbiotas', emoji:'‚öóÔ∏è', type:'points',
    prep:'Tuppers opacos numerados; antifaces; toallitas; pistola(s) de agua.',
    instructions:'Con antifaz, tocan 30s el tupper y adivinan. +1 local a quien acierte.'
  },
  { id:'tiktok', category:'Introducci√≥n de Olga al clan', title:'Try Not to Laugh ‚Äî TikTok (QR)', emoji:'üï∫', type:'points',
    prep:'Playlist/QR, m√≥vil/altavoz, vasos, cubo/toalla.',
    instructions:'Duelos con agua en la boca. El que r√≠a/escupa pierde la ronda. Al final gana 1 global el mayor; empate +1 a ambos.'
  },
  { id:'cata', category:'Rutina en Barcelona', title:'Cata de bebidas (a ciegas)', emoji:'ü•§', type:'versus',
    prep:'Caja opaca con pajitas; bebidas; pajitas nuevas por turno.',
    instructions:'Por turnos eligen un agujero y beben. Al final: Uri / Olga / Empate y suma al global.'
  },
  { id:'siameses', category:'Fusi√≥n en Uriga', title:'Mini‚Äëretos a dos manos', emoji:'ü§ù', type:'ritual',
    prep:'Cinta; mesa; hoja A4; papel+celo (m√°x 3)+tijeras+objeto; globo+rotulador.',
    instructions:'Tres tareas cooperativas con una mano cada uno. Sin puntos.'
  },
  { id:'musical', category:'Fusi√≥n en Uriga', title:'Vivir en un musical ‚Äî Escenas', emoji:'üé§', type:'ritual',
    prep:'Lista de escenas; altavoz.',
    instructions:'Impro musical 60‚Äì90s. Sin puntos.'
  },
  { id:'yincana', category:'UriGPT', title:'Yincana de fotos ‚Äî Multiagente Edition', emoji:'üì∏', type:'versus',
    prep:'1 m√≥vil por equipo. 12‚Äì15 min.',
    instructions:'Fotos recreando roles de Uri con condiciones. Al final: Uri / Olga / Empate y suma al global.'
  },
  { id:'recogida', category:'Vida en el Palacete', title:'Recogida a ciegas', emoji:'üôà', type:'versus',
    prep:'Campo con piezas y obst√°culos blandos; 2 antifaces.',
    instructions:'Un ciego por equipo recoge piezas guiado por voz. Al final: Uri / Olga / Empate y suma al global.'
  },
  { id:'nofoto', category:'Vida en el Palacete', title:'No salgas en la foto (cucarachas)', emoji:'ü™≥', type:'versus',
    prep:'Delimitar sal√≥n; c√°mara sin flash; antifaz.',
    instructions:'Fot√≥grafo a ciegas captura ‚Äúcucarachas‚Äù. Al final: Uri / Olga / Empate y suma al global.'
  },
  { id:'riego', category:'Vida en el Palacete', title:'Riego Milagroso ‚Äî Pasa el agua atr√°s', emoji:'üíß', type:'versus',
    prep:'Dos filas por equipos; botellas y recipientes; tupper final.',
    instructions:'Cadena de agua sin girarse. Al final: Uri / Olga / Empate y suma al global.'
  },
  { id:'sprite', category:'Bonus Final', title:'Exorcismo de Maitreya', emoji:'ü´ß', type:'points',
    prep:'Sprite fr√≠a en vasos iguales; toallas.',
    instructions:'Duelo bebiendo; si eructa uno, +1 local al otro. Al final: mayor gana 1 global; empate +1 a ambos.'
  }
];

// Build default state for DB
function defaultDbState(){
  const games = {};
  for(const g of GAMES_META){
    games[g.id] = { done:false, result:null, local:{uri:0, olga:0}, type:g.type };
  }
  return { scores:{uri:0, olga:0}, games, rev: Date.now(), resetAt: { ".sv": "timestamp" } };
}

// --- DOM helpers ---
const $ = (q)=>document.querySelector(q);
const tiles = $('#tiles');
const uriScoreEl = $('#uriScore');
const olgaScoreEl = $('#olgaScore');
const progressText = $('#progressText');
const progressBar = $('#progressBar');
const backdrop = $('#backdrop');
const closeBtn = $('#closeDetail');
closeBtn.addEventListener('click', closeDetail);
backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) closeDetail(); });

let FILTER = 'all';
document.querySelectorAll('.chip').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    ch.classList.add('active');
    FILTER = ch.dataset.filter;
    renderTiles(); // uses lastSnapshot
  });
});

// Skeletons
function renderSkeletons(count=6){
  tiles.innerHTML = '';
  for(let i=0;i<count;i++){
    const s = document.createElement('article');
    s.className = 'card skeleton';
    s.innerHTML = `
      <div class="sk-line sk-meta"></div>
      <div class="sk-line sk-title"></div>
      <div class="sk-line" style="width:60%"></div>
    `;
    tiles.appendChild(s);
  }
}
renderSkeletons();

// Firebase init + auth gate
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let lastSnapshot = null;
let currentRev = 0;
let IS_RESETTING = false;

onAuthStateChanged(auth, async (user)=>{
  if(!user){
    try{ await signInAnonymously(auth); } catch(e){ showToast('Auth error'); return; }
  }
  attachRealtime();
});

function attachRealtime(){
  const rootRef = ref(db, '/');
  onValue(rootRef, (snap)=>{
    const data = snap.val();
    if(!data){
      // bootstrap database
      set(rootRef, defaultDbState()).catch(()=>{});
      return;
    }
    lastSnapshot = data;
    currentRev = data.rev || 0;
    renderAll(data);
  });
}

// Renderers
function renderAll(state){
  // scores
  const s = state.scores || {uri:0, olga:0};
  uriScoreEl.textContent = s.uri ?? 0;
  olgaScoreEl.textContent = s.olga ?? 0;
  // progress
  const games = state.games || {};
  const total = GAMES_META.length;
  const done = Object.values(games).filter(g=>g.done).length;
  progressText.textContent = `${done} de ${total} completados`;
  progressBar.style.width = `${(done/total)*100}%`;
  // tiles
  renderTiles();
}

function renderTiles(){
  if(!lastSnapshot){ renderSkeletons(); return; }
  const gamesState = lastSnapshot.games || {};
  tiles.innerHTML = '';
  GAMES_META.forEach((g, idx)=>{
    const gs = gamesState[g.id] || {done:false};
    const completed = !!gs.done;
    if(FILTER==='pending' && completed) return;
    if(FILTER==='done' && !completed) return;

    const el = document.createElement('article');
    el.className = 'card' + (completed ? ' completed' : '');
    el.setAttribute('data-id', g.id);
    el.innerHTML = `
      <div class="meta-row"><span>${g.category}</span></div>
      <span class="title">${g.emoji} ${String(idx+1).padStart(2,'0')}. ${g.title}</span>
      ${completed ? `<div class="badge"><span class="check">‚úì</span>Completado</div>`:''}
    `;
    el.addEventListener('click', ()=>openDetail(g.id));
    tiles.appendChild(el);
  });
}

// Toast helper
function showToast(msg){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>{ t.style.display='none'; }, 1800);
}

// Modal logic (re-uses lastSnapshot + writes to DB)
function openDetail(id){
  if(!lastSnapshot) return;
  const meta = GAMES_META.find(x=>x.id===id);
  const state = lastSnapshot.games?.[id] || {done:false, result:null, local:{uri:0,olga:0}, type:meta.type};

  $('#detailCategory').textContent = meta.category;
  $('#detailTitle').textContent = meta.title;
  $('#detailPrep').textContent = meta.prep;
  $('#detailInstr').textContent = meta.instructions;

  const sc = $('#scoringControls');
  const hint = $('#scoringHint');
  sc.innerHTML = '';
  hint.style.display = 'none';

  if(meta.type==='points'){
    const {uri=0, olga=0} = state.local || {};
    const wrap = document.createElement('div');
    wrap.className = 'controls responsive center';
    wrap.innerHTML = `
      <div class="counter"><strong>Uri</strong>
        <button class="btn ghost" id="uMinus">‚àí1</button>
        <span class="score" id="uScore">${uri}</span>
        <button class="btn primary" id="uPlus">+1</button>
      </div>
      <div class="counter"><strong>Olga</strong>
        <button class="btn ghost" id="oMinus">‚àí1</button>
        <span class="score" id="oScore">${olga}</span>
        <button class="btn primary" id="oPlus">+1</button>
      </div>
      <div class="controls stack" style="width:100%;max-width:420px">
        <button class="btn ghost" id="resetLocal">Reset rondas</button>
        <button class="btn primary" id="finalize">Finalizar juego</button>
        <button class="btn danger" id="clearResult">Quitar resultado</button>
      </div>
    `;
    sc.appendChild(wrap);

    function writeLocal(newU,newO){
      const path = ref(db, `/games/${id}/local`);
      update(path, {uri:newU, olga:newO, updatedAt: serverTimestamp()}).catch(()=>showToast('Error guardando'));
      // Optimistic UI:
      $('#uScore').textContent = newU;
      $('#oScore').textContent = newO;
    }

    wrap.querySelector('#uPlus').onclick = ()=>{ const u = parseInt($('#uScore').textContent)||0; const o = parseInt($('#oScore').textContent)||0; writeLocal(u+1,o); };
    wrap.querySelector('#uMinus').onclick = ()=>{ const u = Math.max(0, (parseInt($('#uScore').textContent)||0)-1); const o = parseInt($('#oScore').textContent)||0; writeLocal(u,o); };
    wrap.querySelector('#oPlus').onclick = ()=>{ const u = parseInt($('#uScore').textContent)||0; const o = parseInt($('#oScore').textContent)||0; writeLocal(u,o+1); };
    wrap.querySelector('#oMinus').onclick = ()=>{ const u = parseInt($('#uScore').textContent)||0; const o = Math.max(0,(parseInt($('#oScore').textContent)||0)-1); writeLocal(u,o); };
    wrap.querySelector('#resetLocal').onclick = ()=> writeLocal(0,0);

    wrap.querySelector('#finalize').onclick = async ()=>{
      // compute winner from current local labels
      const u = parseInt($('#uScore').textContent)||0;
      const o = parseInt($('#oScore').textContent)||0;
      let outcome = 'DRAW';
      if(u > o) outcome = 'URI';
      else if(o > u) outcome = 'OLGA';

      // if already done, ignore
      const path = ref(db, `/games/${id}`);
      const snap = await get(path);
      const cur = snap.val();
      if(cur && cur.done){ showToast('Ya estaba cerrado'); return; }

      const scores = {...(lastSnapshot?.scores||{uri:0,olga:0})};
      if(outcome==='URI') scores.uri += 1;
      else if(outcome==='OLGA') scores.olga += 1;
      else { scores.uri += 1; scores.olga += 1; }

      const updates = {};
      updates[`/scores`] = scores;
      updates[`/games/${id}/done`] = true;
      updates[`/games/${id}/result`] = outcome;
      updates[`/rev`] = Date.now();
      await update(ref(db, '/'), updates).catch(()=>showToast('Error guardando resultado'));
      showToast('Resultado guardado');
      closeDetail();
    };

    wrap.querySelector('#clearResult').onclick = async ()=>{
      const path = ref(db, `/games/${id}`);
      const snap = await get(path);
      const cur = snap.val();
      if(!cur || !cur.result){ showToast('Sin resultado'); return; }
      const scores = {...(lastSnapshot?.scores||{uri:0,olga:0})};
      if(cur.result==='URI' && scores.uri>0) scores.uri -= 1;
      else if(cur.result==='OLGA' && scores.olga>0) scores.olga -= 1;
      else if(cur.result==='DRAW'){ if(scores.uri>0) scores.uri -= 1; if(scores.olga>0) scores.olga -= 1; }

      const updates = {};
      updates[`/scores`] = scores;
      updates[`/games/${id}`] = { done:false, result:null, local:{uri:0,olga:0}, type:meta.type };
      updates[`/rev`] = Date.now();
      await update(ref(db, '/'), updates).catch(()=>showToast('Error quitando resultado'));
      showToast('Resultado eliminado');
      closeDetail();
    };

  } else if(meta.type==='versus'){
    const wrap = document.createElement('div');
    wrap.className = 'controls responsive center';
    wrap.innerHTML = `
      <label class="choice"><input type="radio" name="winner" value="URI"> Uri gana</label>
      <label class="choice"><input type="radio" name="winner" value="OLGA"> Olga gana</label>
      <label class="choice"><input type="radio" name="winner" value="DRAW"> Empate</label>
      <div class="controls stack" style="width:100%;max-width:420px">
        <button class="btn primary" id="saveResult">Guardar</button>
        <button class="btn danger" id="clearResult">Quitar resultado</button>
      </div>
    `;
    sc.appendChild(wrap);

    // lock UI if already done
    if(state.done){
      wrap.querySelectorAll('input,button').forEach(el=>{
        if(el.id!=='clearResult') el.disabled = true;
      });
      const radio = wrap.querySelector(`input[value="${state.result||'DRAW'}"]`);
      if(radio) radio.checked = true;
    }

    wrap.querySelector('#saveResult').onclick = async ()=>{
      const sel = sc.querySelector('input[name="winner"]:checked');
      if(!sel){ showToast('Selecciona un resultado'); return; }
      const val = sel.value;
      // fetch current to avoid double-save
      const path = ref(db, `/games/${id}`);
      const cur = (await get(path)).val();
      if(cur && cur.done){ showToast('Ya estaba cerrado'); return; }

      const scores = {...(lastSnapshot?.scores||{uri:0,olga:0})};
      if(val==='URI') scores.uri += 1;
      else if(val==='OLGA') scores.olga += 1;
      else { scores.uri += 1; scores.olga += 1; }

      const updates = {};
      updates[`/scores`] = scores;
      updates[`/games/${id}`] = { ...cur, done:true, result:val, local:{uri:0,olga:0}, type:meta.type };
      updates[`/rev`] = Date.now();
      await update(ref(db, '/'), updates).catch(()=>showToast('Error guardando'));
      showToast('Resultado guardado');
      closeDetail();
    };

    wrap.querySelector('#clearResult').onclick = async ()=>{
      const path = ref(db, `/games/${id}`);
      const cur = (await get(path)).val();
      if(!cur || !cur.done){ showToast('Sin resultado'); return; }
      const scores = {...(lastSnapshot?.scores||{uri:0,olga:0})};
      if(cur.result==='URI' && scores.uri>0) scores.uri -= 1;
      else if(cur.result==='OLGA' && scores.olga>0) scores.olga -= 1;
      else if(cur.result==='DRAW'){ if(scores.uri>0) scores.uri -= 1; if(scores.olga>0) scores.olga -= 1; }

      const updates = {};
      updates[`/scores`] = scores;
      updates[`/games/${id}`] = { done:false, result:null, local:{uri:0,olga:0}, type:meta.type };
      updates[`/rev`] = Date.now();
      await update(ref(db, '/'), updates).catch(()=>showToast('Error quitando'));
      showToast('Resultado eliminado');
      closeDetail();
    };

  } else if(meta.type==='ritual'){
    const wrap = document.createElement('div');
    wrap.className = 'controls stack center';
    wrap.innerHTML = `<button class="btn primary" id="markDone">${state.done?'Marcar como NO completado':'Marcar como completado'}</button>`;
    sc.appendChild(wrap);
    wrap.querySelector('#markDone').onclick = async ()=>{
      const newDone = !state.done;
      const updates = {};
      updates[`/games/${id}/done`] = newDone;
      updates[`/games/${id}/result`] = newDone ? 'DONE' : null;
      updates[`/rev`] = Date.now();
      await update(ref(db, '/'), updates).catch(()=>showToast('Error marcando'));
      closeDetail();
    };
  }

  backdrop.style.display = 'flex';
  backdrop.setAttribute('aria-hidden','false');
}

function closeDetail(){
  backdrop.style.display = 'none';
  backdrop.setAttribute('aria-hidden','true');
}

// Reset ALL ‚Äî atomic set at root
$('#resetAll').addEventListener('click', async ()=>{
  if(!auth.currentUser){ showToast('Sin sesi√≥n'); return; }
  try{
    $('#resetAll').disabled = true;
    closeDetail();
    IS_RESETTING = true;
    await set(ref(db, '/'), defaultDbState());
    showToast('Todo reiniciado');
  }catch(e){
    console.error(e);
    showToast('Error al reiniciar');
  }finally{
    IS_RESETTING = false;
    $('#resetAll').disabled = false;
  }
});
</script>
</body>
</html>
